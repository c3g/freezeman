# Generated by Django 3.1 on 2021-10-21 21:20

from django.conf import settings
from django.db import migrations, models
import django.core.validators
from django.contrib.auth.models import User
import django.db.models.deletion
from django.contrib.postgres.fields import ArrayField
import re
import reversion

ADMIN_USERNAME = 'biobankadmin'

def create_mgi_T7_related_objects(apps, schema_editor):
    Platform = apps.get_model("fms_core", "Platform")
    InstrumentType = apps.get_model("fms_core", "InstrumentType")
    Instrument = apps.get_model("fms_core", "Instrument")
    RunType = apps.get_model("fms_core", "RunType")
    Protocol = apps.get_model("fms_core", "Protocol")
    PropertyType = apps.get_model("fms_core", "PropertyType")
    ContentType = apps.get_model('contenttypes', 'ContentType')

    with reversion.create_revision(manage_manually=True):
        admin_user = User.objects.get(username=ADMIN_USERNAME)
        admin_user_id = admin_user.id

        reversion.set_comment("Create objects related to MGI T7 experiment")
        reversion.set_user(admin_user)

        # Platform and InstrumentType already created for MGI T7
        platform = Platform.objects.get(name="DNBSEQ")

        # Instrument dictionary {NAME: TYPE} for creation
        INSTRUMENTS = {
            "01-Marie Curie": "DNBSEQ-G400",
            "02-Frida Kahlo": "DNBSEQ-G400",
            "03-Jennifer Doudna": "DNBSEQ-T7",
        }
        for name in INSTRUMENTS.keys():
            it = InstrumentType.objects.get(type=INSTRUMENTS[name])
            i = Instrument.objects.create(name=name,
                                          type=it,
                                          created_by_id=admin_user_id,
                                          updated_by_id=admin_user_id)
            reversion.add_to_revision(i)

        # Create PropertyType and Protocols
        PROPERTY_TYPES_BY_PROTOCOL = {
            "DNBSEQ Preparation": [("Flowcell Lot", "str"),
                                   ("Loading Method", "str"),
                                   ("Sequencer Side", "str"),
                                   ("Sequencer Kit Used", "str"),
                                   ("Sequencer Kit Lot", "str"),
                                   ("Load DNB Cartridge Lot", "str"),
                                   ("Primer Kit", "str"),
                                   ("Primer Kit Lot", "str"),
                                   ("Read 1 Cycles", "str"),
                                   ("Read 2 Cycles", "str"),
                                   ("Index 1 Cycles", "str"),
                                   ("Index 2 Cycles", "str"),
                                   ],
        }
        protocol_content_type = ContentType.objects.get_for_model(Protocol)

        for protocol_name in PROPERTY_TYPES_BY_PROTOCOL.keys():
            protocol = Protocol.objects.create(name=protocol_name,
                                               created_by_id=admin_user_id, updated_by_id=admin_user_id)
            reversion.add_to_revision(protocol)

            for (property, value_type) in PROPERTY_TYPES_BY_PROTOCOL[protocol_name]:
                is_optional = True if 'comment' in property.lower() else False

                pt = PropertyType.objects.create(name=property,
                                                 object_id=protocol.id,
                                                 content_type=protocol_content_type,
                                                 value_type=value_type,
                                                 is_optional=is_optional,
                                                 created_by_id=admin_user_id, updated_by_id=admin_user_id)
                reversion.add_to_revision(pt)

        # Create RunType MGI T7
        rt = RunType.objects.create(name="DNBSEQ",
                                    platform=platform,
                                    protocol=protocol,
                                    created_by_id=admin_user_id,
                                    updated_by_id=admin_user_id)
        reversion.add_to_revision(rt)


class Migration(migrations.Migration):
    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('fms_core', '0026_v3_5_0'),
    ]
    
    operations = [
        migrations.CreateModel(
            name='FullSample',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='Sample name.', max_length=200, validators=[django.core.validators.RegexValidator(re.compile('^[a-zA-Z0-9.\\-_]{1,200}$'))])),
                ('alias', models.CharField(help_text='Sample alias.', max_length=200)),
                ('volume', models.DecimalField(decimal_places=3, help_text='Current volume of the sample, in µL. ', max_digits=20)),
                ('concentration', models.DecimalField(blank=True, decimal_places=3, help_text='Concentration in ng/µL. Required for nucleic acid samples.', max_digits=20, null=True, verbose_name='concentration in ng/µL')),
                ('depleted', models.BooleanField(default=False, help_text='Whether this sample has been depleted.')),
                ('collection_site', models.CharField(help_text='The facility designated for the collection of samples.', max_length=200)),
                ('tissue_source', models.CharField(blank=True, help_text='Can only be specified if the biospecimen type is DNA or RNA.', max_length=200)),
                ('experimental_group', models.JSONField(blank=True, help_text="Experimental group associated to  sample.")),
                ('creation_date', models.DateField(help_text='Date of the sample reception or extraction.')),
                ('coordinates', models.CharField(blank=True, help_text='Coordinates of the sample in a parent container. Only applicable for containers that directly store samples with coordinates, e.g. plates.', max_length=10)),
                ('container', models.ForeignKey("Container", on_delete=models.DO_NOTHING, help_text="Container associated to the sample.")),
                ('individual', models.ForeignKey("Individual", blank=True, null=True, on_delete=models.DO_NOTHING, help_text="Individual associated with to sample.")),
                ('sample_kind', models.ForeignKey("SampleKind", on_delete=models.DO_NOTHING, help_text="Sample Kind associated to the sample.")),
                ('derived_sample', models.ForeignKey("DerivedSample", on_delete=models.DO_NOTHING, help_text="Sample from which the current sample was extracted from.")),
                ('biosample', models.ForeignKey("Biosample", on_delete=models.DO_NOTHING, help_text="Root Sample")),
                ('child_of', ArrayField(models.CharField(blank=True, max_length=20), help_text="Parent Sample")),
                ('process_measurements', ArrayField(models.CharField(blank=True, max_length=20), help_text="Process measurements associated to the sample")),
                ('projects', ArrayField(models.CharField(blank=True, max_length=20),blank=True, null=True, help_text="Projects which the sample belongs to.")),
                ('projects_names', ArrayField(models.CharField(blank=True, max_length=20), blank=True, null=True, help_text="Projects' names which the sample belongs to.")),
                ('comment', models.CharField(blank=True, help_text='Sample comment.', max_length=200)),
            ],
            options={
                'db_table': 'fms_core_fullsample',
                'managed': False,
            },
        ),
        migrations.RunSQL(
            """
                DROP VIEW IF EXISTS fms_core_fullsample;
                CREATE OR REPLACE VIEW fms_core_fullsample AS
                SELECT sample.id, sample.name, sample.container_id, sample.coordinates, sample.volume, sample.concentration, sample.depleted, array_remove(array_agg(DISTINCT sbyp.project_id), NULL) AS projects, array_remove(array_agg(DISTINCT project.name), NULL) AS projects_names, array_remove(array_agg(pm.id), NULL) AS process_measurements, array_remove(array_agg(DISTINCT sl.parent_id), NULL) AS child_of, sample.comment, sample.creation_date, sample.created_at, sample.updated_at, sample.created_by_id, sample.updated_by_id, sample.deleted, biosample.alias, derived.sample_kind_id, derived.tissue_source, derived.experimental_group, derived.id AS derived_sample_id, derived.biosample_id,  biosample.individual_id, biosample.collection_site
                FROM fms_core_sample AS sample 
                JOIN fms_core_derivedbysample AS dbys 
                ON dbys.sample_id =  sample.id 
                JOIN fms_core_derivedsample AS derived
                ON dbys.derived_sample_id  = derived.id 
                LEFT JOIN fms_core_samplebyproject AS sbyp
                ON sbyp.sample_id = sample.id
                LEFT JOIN fms_core_project AS project
                ON sbyp.project_id = project.id
                LEFT JOIN fms_core_processmeasurement AS pm 
                ON pm.source_sample_id = sample.id
                LEFT JOIN fms_core_samplelineage AS sl 
                ON sl.child_id = sample.id
                JOIN fms_core_biosample AS biosample 
                ON derived.biosample_id = biosample.id GROUP BY sample.id, derived.sample_kind_id, derived.tissue_source, derived.experimental_group, derived.id, derived.biosample_id, biosample.individual_id, biosample.collection_site,  sl.child_id, biosample.id  ORDER BY sample.id;
            """,
            migrations.RunSQL.noop
        ),
        # MGI T7 initial migration
        migrations.RunPython(
            create_mgi_T7_related_objects,
            reverse_code=migrations.RunPython.noop,
        ),
        migrations.AlterField(
            model_name='container',
            name='kind',
            field=models.CharField(choices=[('infinium gs 24 beadchip', 'infinium gs 24 beadchip'), ('dnbseq-g400 flowcell', 'dnbseq-g400 flowcell'), ('dnbseq-t7 flowcell', 'dnbseq-t7 flowcell'), ('tube', 'tube'), ('tube strip 2x1', 'tube strip 2x1'), ('tube strip 3x1', 'tube strip 3x1'), ('tube strip 4x1', 'tube strip 4x1'), ('tube strip 5x1', 'tube strip 5x1'), ('tube strip 6x1', 'tube strip 6x1'), ('tube strip 7x1', 'tube strip 7x1'), ('tube strip 8x1', 'tube strip 8x1'), ('96-well plate', '96-well plate'), ('384-well plate', '384-well plate'), ('tube box 3x3', 'tube box 3x3'), ('tube box 6x6', 'tube box 6x6'), ('tube box 7x7', 'tube box 7x7'), ('tube box 8x8', 'tube box 8x8'), ('tube box 9x9', 'tube box 9x9'), ('tube box 10x10', 'tube box 10x10'), ('tube rack 8x12', 'tube rack 8x12'), ('box', 'box'), ('drawer', 'drawer'), ('freezer rack 2x4', 'freezer rack 2x4'), ('freezer rack 3x4', 'freezer rack 3x4'), ('freezer rack 4x4', 'freezer rack 4x4'), ('freezer rack 5x4', 'freezer rack 5x4'), ('freezer rack 6x4', 'freezer rack 6x4'), ('freezer rack 7x4', 'freezer rack 7x4'), ('freezer rack 10x5', 'freezer rack 10x5'), ('freezer rack 8x6', 'freezer rack 8x6'), ('freezer rack 11x6', 'freezer rack 11x6'), ('freezer rack 11x7', 'freezer rack 11x7'), ('freezer 3 shelves', 'freezer 3 shelves'), ('freezer 4 shelves', 'freezer 4 shelves'), ('freezer 5 shelves', 'freezer 5 shelves'), ('room', 'room')], help_text='What kind of container this is. Dictates the coordinate system and other container-specific properties.', max_length=25),
        ),
        migrations.AlterField(
            model_name='experimentrun',
            name='container',
            field=models.OneToOneField(help_text='Container', limit_choices_to={'kind__in': ('infinium gs 24 beadchip', 'dnbseq-g400 flowcell', 'dnbseq-t7 flowcell')}, on_delete=django.db.models.deletion.PROTECT, related_name='experiment_run', to='fms_core.container'),
        ),
        migrations.AlterField(
            model_name='sample',
            name='container',
            field=models.ForeignKey(help_text='Container in which the sample is placed.', limit_choices_to={'kind__in': ('infinium gs 24 beadchip', 'dnbseq-g400 flowcell', 'dnbseq-t7 flowcell', 'tube', 'tube strip 2x1', 'tube strip 3x1', 'tube strip 4x1', 'tube strip 5x1', 'tube strip 6x1', 'tube strip 7x1', 'tube strip 8x1', '96-well plate', '384-well plate')}, on_delete=django.db.models.deletion.PROTECT, related_name='samples', to='fms_core.container'),
        ),
    ]
